<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hafenmeister Adminpanel</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { margin-bottom: 10px; }
    h2 { margin-top: 30px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #ddd; }
    button { padding: 4px 8px; margin: 2px; }
    pre { background: #111; color: #0f0; padding: 10px; overflow-x: auto; max-height: 300px; }
    .log-container { display: flex; gap: 20px; }
    .log-box { flex: 1; }
  </style>
</head>
<body>
  <h1>‚öì Hafenmeister Dashboard</h1>

  <h2>üì¨ Gespeicherte Nachrichten</h2>
  <table id="messagesTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>User</th>
        <th>Nachricht</th>
        <th>Geplant f√ºr</th>
        <th>Status</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>üìú Logs</h2>
  <div class="log-container" id="logsContainer"></div>

  <script>
    async function loadMessages() {
      const res = await fetch("/messages");
      const data = await res.json();
      const tbody = document.querySelector("#messagesTable tbody");
      tbody.innerHTML = "";
      data.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.id}</td>
          <td><@${m.userId}></td>
          <td>${m.message}</td>
          <td>${new Date(m.scheduledTimestamp).toLocaleString()}</td>
          <td>${m.sent ? "‚úÖ Gesendet" : "‚è≥ Offen"}</td>
          <td>
            <button onclick="sendNow('${m.id}')">Sofort senden</button>
            <button onclick="deleteMsg('${m.id}')">L√∂schen</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    async function sendNow(id) {
      await fetch("/messages/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      loadMessages();
    }

    async function deleteMsg(id) {
      await fetch("/messages/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      loadMessages();
    }

    async function loadLogs() {
      const res = await fetch("/logs");
      const logs = await res.json();
      const container = document.getElementById("logsContainer");
      container.innerHTML = "";
      for (const [bot, l] of Object.entries(logs)) {
        const box = document.createElement("div");
        box.className = "log-box";
        box.innerHTML = `
          <h3>${bot}</h3>
          <strong>stdout:</strong><pre>${l.out}</pre>
          <strong>stderr:</strong><pre>${l.err}</pre>
        `;
        container.appendChild(box);
      }
    }

    // Auto-Refresh alle 10 Sekunden
    setInterval(() => {
      loadMessages();
      loadLogs();
    }, 10000);

    loadMessages();
    loadLogs();
  </script>
</body>
</html>
